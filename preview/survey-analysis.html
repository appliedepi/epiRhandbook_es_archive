<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1 Análisis de encuestas | EpiRhandbook en español</title>
<meta name="author" content="El equipo del manual">
<meta name="description" content="1.1 Resumen Esta página muestra el uso de varios paquetes para el análisis de encuestas. La mayoría de los paquetes R de encuestas se basan en el paquete survey para realizar análisis ponderados....">
<meta name="generator" content="bookdown 0.28 with bs4_book()">
<meta property="og:title" content="1 Análisis de encuestas | EpiRhandbook en español">
<meta property="og:type" content="book">
<meta property="og:description" content="1.1 Resumen Esta página muestra el uso de varios paquetes para el análisis de encuestas. La mayoría de los paquetes R de encuestas se basan en el paquete survey para realizar análisis ponderados....">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="1 Análisis de encuestas | EpiRhandbook en español">
<meta name="twitter:description" content="1.1 Resumen Esta página muestra el uso de varios paquetes para el análisis de encuestas. La mayoría de los paquetes R de encuestas se basan en el paquete survey para realizar análisis ponderados....">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.24/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script>
</head>
<body>
<div class="alert alert-info alert-dismissible">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
      <strong>Need help learning R?</strong> Enroll in Applied Epi's <a href="https://www.appliedepi.org/live/" class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/" class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/" class="alert-link">Community Q&amp;A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org" class="alert-link">R Help Desk service</a>.
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">EpiRhandbook en español</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li><a class="active" href="survey-analysis.html"><span class="header-section-number">1</span> Análisis de encuestas</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">2</span> Análisis de supervivencia</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="survey-analysis" class="section level1" number="1">
<h1>
<span class="header-section-number">1</span> Análisis de encuestas<a class="anchor" aria-label="anchor" href="#survey-analysis"><i class="fas fa-link"></i></a>
</h1>
<!-- ======================================================= -->
<div id="overview-4" class="section level2" number="1.1">
<h2>
<span class="header-section-number">1.1</span> Resumen<a class="anchor" aria-label="anchor" href="#overview-4"><i class="fas fa-link"></i></a>
</h2>
<p>Esta página muestra el uso de varios paquetes para el análisis de encuestas.</p>
<p>La mayoría de los paquetes R de encuestas se basan en el <a href="https://cran.r-project.org/web/packages/survey/index.html">paquete <strong>survey</strong></a> para realizar análisis ponderados. Utilizaremos <strong>survey</strong>, así como <a href="https://cran.r-project.org/web/packages/srvyr/index.html"><strong>srvyr</strong></a> (una envoltura para <strong>survey</strong> que permite la codificación al estilo tidyverse) y <a href="https://cran.r-project.org/web/packages/gtsummary/index.html"><strong>gtsummary</strong></a> (una envoltura para <strong>survey</strong> que permite obtener tablas listas para su publicación). Aunque el paquete original <strong>survey</strong> no permite la codificación al estilo tidyverse, tiene la ventaja añadida de permitir modelos lineales generalizados ponderados por la encuesta (que se añadirán a esta página más adelante). También demostraremos el uso de una función del paquete <a href="https://github.com/R4EPI/sitrep"><strong>sitrep</strong></a> para crear ponderaciones de muestreo (<em>n.b.</em> este paquete no está todavía en CRAN, pero se puede instalar desde github).</p>
<p>La mayor parte de esta página se basa en el trabajo realizado para el <a href="https://r4epis.netlify.app/">proyecto “R4Epis”</a>; para ver el código detallado y las plantillas R-markdown del mismo, consulta la <a href="https://github.com/R4EPI/sitrep">página github de “R4Epis”</a>. Parte del código basado en el paquete de encuestas se basa en las primeras versiones de los <a href="https://github.com/EPIET/RapidAssessmentSurveys">estudios de caso de EPIET</a>.</p>
<p>Actualmente, esta página no aborda el cálculo del tamaño de la muestra ni el muestreo. Para una calculadora del tamaño muestral fácil de usar, consulta <a href="https://www.openepi.com/Menu/OE_Menu.htm">OpenEpi</a>. La página de <a href="#gis-basics">conceptos básicos de los SIG</a> del manual tendrá eventualmente una sección sobre muestreo aleatorio espacial, y esta página tendrá eventualmente una sección sobre marcos de muestreo así como cálculos del tamaño de la muestra.</p>
<ol style="list-style-type: decimal">
<li>Datos de encuestas</li>
<li>Tiempo de observación</li>
<li>Ponderación</li>
<li>Objetos de diseño de la encuesta</li>
<li>Análisis descriptivo</li>
<li>Proporciones ponderadas</li>
<li>Tasas ponderadas</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="preparation-17" class="section level2" number="1.2">
<h2>
<span class="header-section-number">1.2</span> Preparación<a class="anchor" aria-label="anchor" href="#preparation-17"><i class="fas fa-link"></i></a>
</h2>
<div id="paquetes" class="section level3 unnumbered">
<h3>Paquetes<a class="anchor" aria-label="anchor" href="#paquetes"><i class="fas fa-link"></i></a>
</h3>
<p>Este trozo de código muestra la carga de los paquetes necesarios para los análisis. En este manual destacamos <code>p_load()</code> de <strong>pacman</strong>, que instala el paquete si es necesario <em>y</em> lo carga para su uso. También se pueden cargar paquetes con <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> de R <strong>base .</strong> Consulta la página sobre <a href="#r-basics">fundamentos de R</a> para obtener más información sobre los paquetes de R.
Aquí también mostramos el uso de la función <code>p_load_gh()</code> de <strong>pacman</strong> para instalar y cargar un paquete de github que aún no ha sido publicado en CRAN.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## load packages from CRAN</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>,          <span class="co"># File import</span></span>
<span>               <span class="va">here</span>,         <span class="co"># File locator</span></span>
<span>               <span class="va">tidyverse</span>,    <span class="co"># data management + ggplot2 graphics</span></span>
<span>               <span class="va">tsibble</span>,      <span class="co"># handle time series datasets</span></span>
<span>               <span class="va">survey</span>,       <span class="co"># for survey functions</span></span>
<span>               <span class="va">srvyr</span>,        <span class="co"># dplyr wrapper for survey package</span></span>
<span>               <span class="va">gtsummary</span>,    <span class="co"># wrapper for survey package to produce tables</span></span>
<span>               <span class="va">apyramid</span>,     <span class="co"># a package dedicated to creating age pyramids</span></span>
<span>               <span class="va">patchwork</span>,    <span class="co"># for combining ggplots</span></span>
<span>               <span class="va">ggforce</span>       <span class="co"># for alluvial/sankey plots</span></span>
<span>              </span>
<span>               <span class="op">)</span> </span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## load packages from github</span></span>
<span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load_gh.html">p_load_gh</a></span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="st">"r4epi/sitrep"</span> <span class="co"># for observation time / weighting functions</span></span>
<span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="carga-de-datos" class="section level3 unnumbered">
<h3>Carga de datos<a class="anchor" aria-label="anchor" href="#carga-de-datos"><i class="fas fa-link"></i></a>
</h3>
<p>El conjunto de datos de ejemplo utilizado en esta sección:</p>
<ul>
<li>datos de encuesta de mortalidad ficticia.</li>
<li>recuentos de población ficticios para la zona de la encuesta.</li>
<li>diccionario de datos para los datos de la encuesta de mortalidad ficticia.</li>
</ul>
<p>Se basa en la encuesta pre-aprobada por la junta de revisión ética de MSF OCA. Los datos ficticios se produjeron como parte del <a href="https://r4epis.netlify.app/">proyecto “R4Epis”</a>. Todo ello se basa en los datos recopilados mediante <a href="https://www.kobotoolbox.org/">KoboToolbox,</a> un software de recopilación de datos basado en <a href="https://opendatakit.org/">Open Data Kit</a>.</p>
<p>Kobo permite exportar tanto los datos recogidos como el diccionario de datos para ese conjunto de datos. Recomendamos encarecidamente hacer esto, ya que simplifica la limpieza de los datos y es útil para buscar variables/preguntas.</p>
<p><span style="color: darkgreen;"><strong><em>CONSEJO:</em></strong> El diccionario de datos de Kobo tiene nombres de variables en la columna “name” de la hoja de la encuesta. Los valores posibles para cada variable se especifican en la hoja de opciones. En la hoja de opciones, “name” tiene el valor acortado y las columnas “label::english” y “label::french” tienen las versiones largas correspondientes. Si utilizas la función <code>msf_dict_survey()</code> del paquete <strong>epidict</strong> para importar un archivo excel del diccionario Kobo, éste se reformulará para que pueda utilizarse fácilmente para recodificar. </span></p>
<p><span style="color: orange;"><strong><em>PRECAUCIÓN:</em></strong> El conjunto de datos de ejemplo no es lo mismo que una exportación (ya que en Kobo se exportan los diferentes niveles del cuestionario de forma individual) - Mira la sección de datos de la encuesta más abajo para fusionar los diferentes niveles.</span></p>
<p>Los datos se importan mediante la función <code>import()</code> del paquete <strong>rio</strong>. Consulta la página sobre <a href="#import-and-export">importación y exportación</a> para conocer las distintas formas de importar datos.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># import the survey data</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"survey_data.xlsx"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># import the dictionary into R</span></span>
<span><span class="va">survey_dict</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"survey_dict.xlsx"</span><span class="op">)</span> </span></code></pre></div>
<p>Más abajo se muestran las primeras 10 filas de la encuesta</p>
<div id="htmlwidget-74934582a7599702a9e9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-74934582a7599702a9e9">{"x":{"filter":"none","vertical":false,"data":[[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["2018-04-15T00:00:00Z","2018-03-04T00:00:00Z","2018-04-16T00:00:00Z","2018-01-23T00:00:00Z","2018-01-09T00:00:00Z","2018-03-07T00:00:00Z","2018-02-18T00:00:00Z","2018-04-12T00:00:00Z","2018-04-17T00:00:00Z","2018-01-05T00:00:00Z"],[null,null,null,null,null,null,null,null,null,null],["village_1","village_1","village_10","village_5","village_3","village_8","other","village_7","village_4","village_2"],[null,null,null,null,null,null,null,null,null,null],[1,1,10,5,3,8,11,7,4,2],[9,1,15,6,18,14,17,16,13,14],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["yes","no","no","yes","no","yes","no","yes","yes","yes"],[null,"no_benefit","neg_experience",null,"other",null,"no_benefit",null,null,null],[null,null,null,null,null,null,null,null,null,null],[6,null,null,8,null,5,null,6,5,5],["female",null,null,"female",null,"male",null,"male","male","female"],[26,null,null,3,null,22,null,33,96,18],[null,null,null,36,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["no",null,null,"no",null,"yes",null,"yes","yes","yes"],["yes",null,null,null,null,"yes",null,"no","no","no"],["secondary",null,null,null,null,"secondary",null,null,null,null],["no",null,null,"no",null,"yes",null,"no","yes","yes"],[null,null,null,null,null,"yes",null,null,"no","no"],["yes",null,null,null,null,null,null,null,null,"yes"],["no",null,null,"no",null,"yes",null,"yes","no","yes"],["yes",null,null,"no",null,"no",null,"no","yes","yes"],["no",null,null,null,null,null,null,null,"no","no"],[null,null,null,null,null,null,null,null,null,null],["yes",null,null,"no",null,"no",null,"yes","no","no"],["no",null,null,null,null,null,null,"no",null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["no","no","no","no","no","no","no","no","yes","no"],[null,null,null,null,null,null,null,null,"no",null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,"dont_know",null],[null,null,null,null,null,null,null,null,null,null],["yes",null,null,"yes",null,"no",null,"yes","no","no"],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["sexual",null,null,"sexual",null,null,null,"shot",null,null],["0",null,null,"0",null,null,null,"0",null,null],["1",null,null,"1",null,null,null,"0",null,null],["0",null,null,"0",null,null,null,"1",null,null],["0",null,null,"0",null,null,null,"0",null,null],["0",null,null,"0",null,null,null,"0",null,null],["0",null,null,"0",null,null,null,"0",null,null],[9,1,183,83,58,146,205,130,72,33],[1,1,1,1,1,1,1,1,1,1],["9_1","1_1","183_1","83_1","58_1","146_1","205_1","130_1","72_1","33_1"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>start<\/th>\n      <th>end<\/th>\n      <th>today<\/th>\n      <th>deviceid<\/th>\n      <th>date<\/th>\n      <th>team_number<\/th>\n      <th>village_name<\/th>\n      <th>village_other<\/th>\n      <th>cluster_number<\/th>\n      <th>household_number<\/th>\n      <th>households_building<\/th>\n      <th>random_hh<\/th>\n      <th>random_hh_note<\/th>\n      <th>consent<\/th>\n      <th>no_consent_reason<\/th>\n      <th>no_consent_other<\/th>\n      <th>member_number<\/th>\n      <th>sex<\/th>\n      <th>age_years<\/th>\n      <th>age_months_calc<\/th>\n      <th>age_months<\/th>\n      <th>bednet<\/th>\n      <th>read_write<\/th>\n      <th>education_level<\/th>\n      <th>measles_vaccination<\/th>\n      <th>vaccination_card<\/th>\n      <th>pregnant<\/th>\n      <th>malaria_treatment<\/th>\n      <th>arrived<\/th>\n      <th>remember_arrival<\/th>\n      <th>arrived_date<\/th>\n      <th>left<\/th>\n      <th>remember_departure<\/th>\n      <th>left_date<\/th>\n      <th>born<\/th>\n      <th>remember_dob<\/th>\n      <th>birthday_date<\/th>\n      <th>died<\/th>\n      <th>remember_death<\/th>\n      <th>death_date<\/th>\n      <th>cause<\/th>\n      <th>cause_other<\/th>\n      <th>violent_episode<\/th>\n      <th>violent_episodes_number<\/th>\n      <th>violence_nature_other<\/th>\n      <th>violence_nature<\/th>\n      <th>violence_nature/beaten<\/th>\n      <th>violence_nature/sexual<\/th>\n      <th>violence_nature/shot<\/th>\n      <th>violence_nature/detained_kidnapped<\/th>\n      <th>violence_nature/other<\/th>\n      <th>violence_nature/no_response<\/th>\n      <th>index<\/th>\n      <th>index_y<\/th>\n      <th>uid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[8,9,16,18,19,20,52,53]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>También queremos importar los datos de la población de muestreo para poder elaborar las ponderaciones adecuadas. Estos datos pueden estar en diferentes formatos, sin embargo sugerimos tenerlos como se ve a continuación (esto puede ser simplemente escrito en un Excel).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># import the population data</span></span>
<span><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"population.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>A continuación se muestran las 10 primeras filas de la encuesta.</p>
<div id="htmlwidget-0b0d42768d9b24b5e372" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-0b0d42768d9b24b5e372">{"x":{"filter":"none","vertical":false,"data":[["0-2","3-14","15-29","30-44","45+","0-2","3-14","15-29","30-44","45+"],["male","male","male","male","male","female","female","female","female","female"],[0.034,0.1811,0.138,0.0808,0.0661,0.034,0.1811,0.138,0.0808,0.0661],[340,1811,1380,808,661,340,1811,1380,808,661],["district_a","district_a","district_a","district_a","district_a","district_a","district_a","district_a","district_a","district_a"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>age_group<\/th>\n      <th>sex<\/th>\n      <th>proportions<\/th>\n      <th>population<\/th>\n      <th>health_district<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>En el caso de las encuestas por conglomerados, es posible que desees añadir ponderaciones de la encuesta a nivel de conglomerado. Puedes introducir estos datos como se indica más arriba. Alternativamente, si sólo hay unos pocos recuentos, éstos podrían introducirse como se indica a continuación en un tibble. En cualquier caso, tendrá que tener una columna con un identificador de conglomerado que coincida con los datos de tu encuesta, y otra columna con el número de hogares en cada conglomerado.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define the number of households in each cluster</span></span>
<span><span class="va">cluster_counts</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"village_1"</span>, <span class="st">"village_2"</span>, <span class="st">"village_3"</span>, <span class="st">"village_4"</span>, </span>
<span>                                     <span class="st">"village_5"</span>, <span class="st">"village_6"</span>, <span class="st">"village_7"</span>, <span class="st">"village_8"</span>,</span>
<span>                                     <span class="st">"village_9"</span>, <span class="st">"village_10"</span><span class="op">)</span>, </span>
<span>                         households <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">700</span>, <span class="fl">400</span>, <span class="fl">600</span>, <span class="fl">500</span>, <span class="fl">300</span>, </span>
<span>                                        <span class="fl">800</span>, <span class="fl">700</span>, <span class="fl">400</span>, <span class="fl">500</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="limpieza-de-datos" class="section level3 unnumbered">
<h3>Limpieza de datos<a class="anchor" aria-label="anchor" href="#limpieza-de-datos"><i class="fas fa-link"></i></a>
</h3>
<p>A continuación se asegura que la columna de fechas tenga el formato adecuado. Hay varias otras maneras de hacer esto (ver la página <a href="#working-with-dates">Trabajar con fechas</a> para más detalles), sin embargo, usar el diccionario para definir las fechas es rápido y fácil.</p>
<p>También creamos una variable de grupo de edad utilizando la función <code>age_categories()</code> de <strong>epikit</strong> - véase la sección del manual de <a href="#cleaning-data-and-core-functions.html#num_cats">limpieza de datos</a> para más detalles. Además, creamos una variable de carácter que define en qué distrito se encuentran las distintas agrupaciones.</p>
<p>Por último, recodificamos todas las variables sí/no en variables VERDADERO/FALSO, ya que de lo contrario no pueden ser utilizadas por las funciones de proporción de <strong>survey</strong>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## select the date variable names from the dictionary </span></span>
<span><span class="va">DATEVARS</span> <span class="op">&lt;-</span> <span class="va">survey_dict</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"date"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survey_data</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## filter to match the column names of your data</span></span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="co"># select date vars</span></span>
<span>  </span>
<span><span class="co">## change to dates </span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">DATEVARS</span><span class="op">)</span>, <span class="va">as.Date</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## add those with only age in months to the year variable (divide by twelve)</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>age_years <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age_years</span><span class="op">)</span>, </span>
<span>                             <span class="va">age_months</span> <span class="op">/</span> <span class="fl">12</span>, </span>
<span>                             <span class="va">age_years</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define age group variable</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>     <span class="fu">mutate</span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu">age_categories</span><span class="op">(</span><span class="va">age_years</span>, </span>
<span>                                    breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">15</span>, <span class="fl">30</span>, <span class="fl">45</span><span class="op">)</span></span>
<span>                                    <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## create a character variable based off groups of a different variable </span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>health_district <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">cluster_number</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">~</span> <span class="st">"district_a"</span>, </span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"district_b"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## select the yes/no variable names from the dictionary </span></span>
<span><span class="va">YNVARS</span> <span class="op">&lt;-</span> <span class="va">survey_dict</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"yn"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survey_data</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## filter to match the column names of your data</span></span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="co"># select yn vars</span></span>
<span>  </span>
<span><span class="co">## change to dates </span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">YNVARS</span><span class="op">)</span>, </span>
<span>                <span class="va">str_detect</span>, </span>
<span>                pattern <span class="op">=</span> <span class="st">"yes"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="survey-data" class="section level2" number="1.3">
<h2>
<span class="header-section-number">1.3</span> Datos de encuestas<a class="anchor" aria-label="anchor" href="#survey-data"><i class="fas fa-link"></i></a>
</h2>
<p>Existen numerosos diseños de muestreo que pueden utilizarse para las encuestas. Aquí mostraremos el código para:
- Estratificado
- Conglomerado
- Estratificado y conglomerado</p>
<p>Como se ha descrito anteriormente (dependiendo de cómo se diseñe el cuestionario) los datos de cada nivel se exportarían como unos datos separados desde Kobo. En nuestro ejemplo hay un nivel para los hogares y un nivel para los individuos dentro de esos hogares.</p>
<p>Estos dos niveles están vinculados por un identificador único. Para unos datos de Kobo, esta variable es “_index” en el nivel del hogar, que coincide con “_parent_index” en el nivel individual. Esto creará nuevas filas para el hogar con cada individuo que coincida, véase la sección del manual sobre <a href="#joining-data">unir datos</a> para más detalles.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## join the individual and household data to form a complete data set</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">survey_data_hh</span>, </span>
<span>                         <span class="va">survey_data_indiv</span>,</span>
<span>                         by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_index"</span> <span class="op">=</span> <span class="st">"_parent_index"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## create a unique identifier by combining indeces of the two levels </span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>     <span class="fu">mutate</span><span class="op">(</span>uid <span class="op">=</span> <span class="fu">str_glue</span><span class="op">(</span><span class="st">"{index}_{index_y}"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="observation-time" class="section level2" number="1.4">
<h2>
<span class="header-section-number">1.4</span> Tiempo de observación<a class="anchor" aria-label="anchor" href="#observation-time"><i class="fas fa-link"></i></a>
</h2>
<p>En el caso de las encuestas de mortalidad, queremos saber cuánto tiempo ha estado presente cada individuo en el lugar para poder calcular una tasa de mortalidad adecuada para nuestro periodo de interés. Esto no es relevante para todas las encuestas, pero en particular para las encuestas de mortalidad es importante, ya que se realizan con frecuencia entre poblaciones móviles o desplazadas.</p>
<p>Para ello, primero definimos nuestro periodo de interés, también conocido como periodo de recuerdo (es decir, el tiempo sobre el que se pide a los participantes que informen al responder a las preguntas). A continuación, podemos utilizar este periodo para establecer las fechas inadecuadas como ausentes, es decir, si las muertes se notifican fuera del periodo de interés.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## set the start/end of recall period</span></span>
<span><span class="co">## can be changed to date variables from dataset </span></span>
<span><span class="co">## (e.g. arrival date &amp; date questionnaire)</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>recall_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2018-01-01"</span><span class="op">)</span>, </span>
<span>         recall_end   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2018-05-01"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># set inappropriate dates to NA based on rules </span></span>
<span><span class="co">## e.g. arrivals before start, departures departures after end</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">mutate</span><span class="op">(</span></span>
<span>           arrived_date <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">arrived_date</span> <span class="op">&lt;</span> <span class="va">recall_start</span>, </span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>                                  <span class="va">arrived_date</span><span class="op">)</span>,</span>
<span>           birthday_date <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">birthday_date</span> <span class="op">&lt;</span> <span class="va">recall_start</span>,</span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>                                  <span class="va">birthday_date</span><span class="op">)</span>,</span>
<span>           left_date <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">left_date</span> <span class="op">&gt;</span> <span class="va">recall_end</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>                               <span class="va">left_date</span><span class="op">)</span>,</span>
<span>           death_date <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">death_date</span> <span class="op">&gt;</span> <span class="va">recall_end</span>,</span>
<span>                               <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>                               <span class="va">death_date</span><span class="op">)</span></span>
<span>           <span class="op">)</span></span></code></pre></div>
<p>Entonces podemos utilizar nuestras variables de fecha para definir las fechas de inicio y fin de cada individuo. Podemos utilizar la función <code>find_start_date()</code> de <strong>sitrep</strong> para afinar la elección de las fechas y luego utilizarla para calcular la diferencia entre días (persona-tiempo).</p>
<p>Fecha de inicio:
Evento de llegada más temprano dentro del período de recogida O bien el inicio del período de recogida (definidas de antemano), o una fecha posterior al inicio de la recogida, si procede (por ejemplo, llegadas o nacimientos)</p>
<p>Fecha de finalización:
Evento de salida más temprano dentro del periodo de recogida O bien el final del periodo de recogida, o una fecha anterior al final de la recogida si procede (por ejemplo, salidas, fallecimientos)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## create new variables for start and end dates/causes</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>     <span class="co">## choose earliest date entered in survey</span></span>
<span>     <span class="co">## from births, household arrivals, and camp arrivals </span></span>
<span>     <span class="fu">find_start_date</span><span class="op">(</span><span class="st">"birthday_date"</span>,</span>
<span>                  <span class="st">"arrived_date"</span>,</span>
<span>                  period_start <span class="op">=</span> <span class="st">"recall_start"</span>,</span>
<span>                  period_end   <span class="op">=</span> <span class="st">"recall_end"</span>,</span>
<span>                  datecol      <span class="op">=</span> <span class="st">"startdate"</span>,</span>
<span>                  datereason   <span class="op">=</span> <span class="st">"startcause"</span> </span>
<span>                 <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>     <span class="co">## choose earliest date entered in survey</span></span>
<span>     <span class="co">## from camp departures, death and end of the study</span></span>
<span>     <span class="fu">find_end_date</span><span class="op">(</span><span class="st">"left_date"</span>,</span>
<span>                <span class="st">"death_date"</span>,</span>
<span>                period_start <span class="op">=</span> <span class="st">"recall_start"</span>,</span>
<span>                period_end   <span class="op">=</span> <span class="st">"recall_end"</span>,</span>
<span>                datecol      <span class="op">=</span> <span class="st">"enddate"</span>,</span>
<span>                datereason   <span class="op">=</span> <span class="st">"endcause"</span> </span>
<span>               <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## label those that were present at the start/end (except births/deaths)</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>     <span class="fu">mutate</span><span class="op">(</span></span>
<span>       <span class="co">## fill in start date to be the beginning of recall period (for those empty) </span></span>
<span>       startdate <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">startdate</span><span class="op">)</span>, <span class="va">recall_start</span>, <span class="va">startdate</span><span class="op">)</span>, </span>
<span>       <span class="co">## set the start cause to present at start if equal to recall period </span></span>
<span>       <span class="co">## unless it is equal to the birth date </span></span>
<span>       startcause <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">startdate</span> <span class="op">==</span> <span class="va">recall_start</span> <span class="op">&amp;</span> <span class="va">startcause</span> <span class="op">!=</span> <span class="st">"birthday_date"</span>,</span>
<span>                              <span class="st">"Present at start"</span>, <span class="va">startcause</span><span class="op">)</span>, </span>
<span>       <span class="co">## fill in end date to be end of recall period (for those empty) </span></span>
<span>       enddate <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">enddate</span><span class="op">)</span>, <span class="va">recall_end</span>, <span class="va">enddate</span><span class="op">)</span>, </span>
<span>       <span class="co">## set the end cause to present at end if equall to recall end </span></span>
<span>       <span class="co">## unless it is equal to the death date</span></span>
<span>       endcause <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">enddate</span> <span class="op">==</span> <span class="va">recall_end</span> <span class="op">&amp;</span> <span class="va">endcause</span> <span class="op">!=</span> <span class="st">"death_date"</span>, </span>
<span>                            <span class="st">"Present at end"</span>, <span class="va">endcause</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Define observation time in days</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>obstime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">enddate</span> <span class="op">-</span> <span class="va">startdate</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="weighting" class="section level2" number="1.5">
<h2>
<span class="header-section-number">1.5</span> Ponderación<a class="anchor" aria-label="anchor" href="#weighting"><i class="fas fa-link"></i></a>
</h2>
<p>Es importante que elimines las observaciones erróneas antes de añadir los pesos de la encuesta. Por ejemplo, si hay observaciones con tiempo de observación negativo, tendrás que comprobarlas (puedes hacerlo con la función <code>assert_positive_timespan()</code> de <strong>sitrep</strong>. Otra cosa es si quieres eliminar las filas vacías (por ejemplo, con <code>drop_na(uid)</code>) o eliminar los duplicados (véase la sección del manual sobre <a href="#de-duplication">De-duplicación</a> para más detalles). También hay que eliminar las que no tienen consentimiento.</p>
<p>En este ejemplo, filtramos los casos que queremos eliminar y los almacenamos en un dataframe separado, de forma que podamos describir los que fueron excluidos de la encuesta. A continuación, utilizamos la función <code>anti_join()</code> de <strong>dplyr</strong> para eliminar estos casos descartados de los datos de nuestra encuesta.</p>
<p><span style="color: red;"><strong><em>PELIGRO:</em></strong> No puede haber valores faltantes en la variable de peso, ni en ninguna de las variables relevantes para el diseño de la encuesta (por ejemplo, edad, sexo, estratos o variables de agrupación).</span></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## store the cases that you drop so you can describe them (e.g. non-consenting </span></span>
<span><span class="co">## or wrong village/cluster)</span></span>
<span><span class="va">dropped</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">consent</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">startdate</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">enddate</span><span class="op">)</span> <span class="op">|</span> <span class="va">village_name</span> <span class="op">==</span> <span class="st">"other"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## use the dropped cases to remove the unused rows from the survey data set  </span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">anti_join</span><span class="op">(</span><span class="va">survey_data</span>, <span class="va">dropped</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dropped</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Como se ha mencionado anteriormente, demostramos cómo añadir ponderaciones para tres diseños de estudio diferentes (estratificado, conglomerado y conglomerado estratificado). Estos requieren información sobre la población de origen y/o los conglomerados encuestados. Utilizaremos el código de conglomerado estratificado para este ejemplo, pero utiliza el que sea más apropiado para tu diseño de estudio.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># stratified ------------------------------------------------------------------</span></span>
<span><span class="co"># create a variable called "surv_weight_strata"</span></span>
<span><span class="co"># contains weights for each individual - by age group, sex and health district</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">add_weights_strata</span><span class="op">(</span>x <span class="op">=</span> <span class="va">survey_data</span>,</span>
<span>                                         p <span class="op">=</span> <span class="va">population</span>,</span>
<span>                                         surv_weight <span class="op">=</span> <span class="st">"surv_weight_strata"</span>,</span>
<span>                                         surv_weight_ID <span class="op">=</span> <span class="st">"surv_weight_ID_strata"</span>,</span>
<span>                                         <span class="va">age_group</span>, <span class="va">sex</span>, <span class="va">health_district</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## cluster ---------------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># get the number of people of individuals interviewed per household</span></span>
<span><span class="co"># adds a variable with counts of the household (parent) index variable</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_count</span><span class="op">(</span><span class="va">index</span>, name <span class="op">=</span> <span class="st">"interviewed"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## create cluster weights</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">add_weights_cluster</span><span class="op">(</span>x <span class="op">=</span> <span class="va">survey_data</span>,</span>
<span>                                          cl <span class="op">=</span> <span class="va">cluster_counts</span>,</span>
<span>                                          eligible <span class="op">=</span> <span class="va">member_number</span>,</span>
<span>                                          interviewed <span class="op">=</span> <span class="va">interviewed</span>,</span>
<span>                                          cluster_x <span class="op">=</span> <span class="va">village_name</span>,</span>
<span>                                          cluster_cl <span class="op">=</span> <span class="va">cluster</span>,</span>
<span>                                          household_x <span class="op">=</span> <span class="va">index</span>,</span>
<span>                                          household_cl <span class="op">=</span> <span class="va">households</span>,</span>
<span>                                          surv_weight <span class="op">=</span> <span class="st">"surv_weight_cluster"</span>,</span>
<span>                                          surv_weight_ID <span class="op">=</span> <span class="st">"surv_weight_ID_cluster"</span>,</span>
<span>                                          ignore_cluster <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                          ignore_household <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># stratified and cluster ------------------------------------------------------</span></span>
<span><span class="co"># create a survey weight for cluster and strata</span></span>
<span><span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>surv_weight_cluster_strata <span class="op">=</span> <span class="va">surv_weight_strata</span> <span class="op">*</span> <span class="va">surv_weight_cluster</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="survey-design-objects" class="section level2" number="1.6">
<h2>
<span class="header-section-number">1.6</span> Objetos de diseño de la encuesta<a class="anchor" aria-label="anchor" href="#survey-design-objects"><i class="fas fa-link"></i></a>
</h2>
<p>Crea un objeto de encuesta de acuerdo con el diseño de tu estudio. Se utiliza de la misma manera que los dataframes para calcular las proporciones ponderadas, etc. Asegúrate que todas las variables necesarias están creadas antes de esto.</p>
<p>Hay cuatro opciones, comenta las que no utilizas:
- Aleatorio simple
- Estratificado
- Conglomerado
- Conglomerado estratificado</p>
<p>Para esta plantilla, supondremos que agrupamos las encuestas en dos estratos distintos (distritos sanitarios A y B). Por lo tanto, para obtener las estimaciones globales necesitamos haber combinado las ponderaciones de los grupos y de los estratos.</p>
<p>Como se ha mencionado anteriormente, hay dos paquetes disponibles para hacer esto. El clásico es <strong>survey</strong> y luego hay un paquete envolvente llamado <strong>srvyr</strong> que hace objetos y funciones amigables con tidyverse. Mostraremos ambos, pero ten en cuenta que la mayor parte del código de este capítulo utilizará objetos basados en <strong>srvyr</strong>. La única excepción es que el paquete <strong>gtsummary</strong> sólo acepta objetos de <strong>survey</strong>.</p>
<div id="paquete-survey" class="section level3 unnumbered">
<h3>Paquete <strong>survey</strong><a class="anchor" aria-label="anchor" href="#paquete-survey"><i class="fas fa-link"></i></a>
</h3>
<p>El paquete <strong>survey</strong> utiliza efectivamente la codificación de R <strong>base</strong>, por lo que no es posible utilizar pipes (<code>%&gt;%</code>) u otra sintaxis de <strong>dplyr</strong>. Con el paquete de <strong>survey</strong> utilizamos la función <code>svydesign()</code> para definir un objeto de encuesta con clusters, pesos y estratos adecuados.</p>
<p><span style="color: black;"><strong><em>NOTA:</em></strong> necesitamos utilizar la tilde (<code>~</code>) delante de las variables, esto es porque el paquete utiliza la sintaxis de R <strong>base</strong> de asignación de variables basadas en fórmulas.</span></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simple random ---------------------------------------------------------------</span></span>
<span><span class="va">base_survey_design_simple</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>, <span class="co"># 1 for no cluster ids</span></span>
<span>                   weights <span class="op">=</span> <span class="cn">NULL</span>,               <span class="co"># No weight added</span></span>
<span>                   strata <span class="op">=</span> <span class="cn">NULL</span>,                <span class="co"># sampling was simple (no strata)</span></span>
<span>                   data <span class="op">=</span> <span class="va">survey_data</span>            <span class="co"># have to specify the dataset</span></span>
<span>                  <span class="op">)</span></span>
<span></span>
<span><span class="co">## stratified ------------------------------------------------------------------</span></span>
<span><span class="va">base_survey_design_strata</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,  <span class="co"># 1 for no cluster ids</span></span>
<span>                   weights <span class="op">=</span> <span class="op">~</span><span class="va">surv_weight_strata</span>, <span class="co"># weight variable created above</span></span>
<span>                   strata <span class="op">=</span> <span class="op">~</span><span class="va">health_district</span>,     <span class="co"># sampling was stratified by district</span></span>
<span>                   data <span class="op">=</span> <span class="va">survey_data</span>             <span class="co"># have to specify the dataset</span></span>
<span>                  <span class="op">)</span></span>
<span></span>
<span><span class="co"># cluster ---------------------------------------------------------------------</span></span>
<span><span class="va">base_survey_design_cluster</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="va">village_name</span>, <span class="co"># cluster ids</span></span>
<span>                   weights <span class="op">=</span> <span class="op">~</span><span class="va">surv_weight_cluster</span>, <span class="co"># weight variable created above</span></span>
<span>                   strata <span class="op">=</span> <span class="cn">NULL</span>,                 <span class="co"># sampling was simple (no strata)</span></span>
<span>                   data <span class="op">=</span> <span class="va">survey_data</span>              <span class="co"># have to specify the dataset</span></span>
<span>                  <span class="op">)</span></span>
<span></span>
<span><span class="co"># stratified cluster ----------------------------------------------------------</span></span>
<span><span class="va">base_survey_design</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="va">village_name</span>,      <span class="co"># cluster ids</span></span>
<span>                   weights <span class="op">=</span> <span class="op">~</span><span class="va">surv_weight_cluster_strata</span>, <span class="co"># weight variable created above</span></span>
<span>                   strata <span class="op">=</span> <span class="op">~</span><span class="va">health_district</span>,             <span class="co"># sampling was stratified by district</span></span>
<span>                   data <span class="op">=</span> <span class="va">survey_data</span>                     <span class="co"># have to specify the dataset</span></span>
<span>                  <span class="op">)</span></span></code></pre></div>
</div>
<div id="paquete-srvyr" class="section level3 unnumbered">
<h3>Paquete <strong>Srvyr</strong><a class="anchor" aria-label="anchor" href="#paquete-srvyr"><i class="fas fa-link"></i></a>
</h3>
<p>Con el paquete <strong>srvyr</strong> podemos utilizar la función <code>as_survey_design()</code>, que tiene los mismos argumentos que la anterior pero permite los pipes (<code>%&gt;%</code>), por lo que no es necesario utilizar la tilde (<code>~</code>).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## simple random ---------------------------------------------------------------</span></span>
<span><span class="va">survey_design_simple</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as_survey_design</span><span class="op">(</span>ids <span class="op">=</span> <span class="fl">1</span>, <span class="co"># 1 for no cluster ids </span></span>
<span>                   weights <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># No weight added</span></span>
<span>                   strata <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># sampling was simple (no strata)</span></span>
<span>                  <span class="op">)</span></span>
<span><span class="co">## stratified ------------------------------------------------------------------</span></span>
<span><span class="va">survey_design_strata</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_survey_design</span><span class="op">(</span>ids <span class="op">=</span> <span class="fl">1</span>, <span class="co"># 1 for no cluster ids</span></span>
<span>                   weights <span class="op">=</span> <span class="va">surv_weight_strata</span>, <span class="co"># weight variable created above</span></span>
<span>                   strata <span class="op">=</span> <span class="va">health_district</span> <span class="co"># sampling was stratified by district</span></span>
<span>                  <span class="op">)</span></span>
<span><span class="co">## cluster ---------------------------------------------------------------------</span></span>
<span><span class="va">survey_design_cluster</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_survey_design</span><span class="op">(</span>ids <span class="op">=</span> <span class="va">village_name</span>, <span class="co"># cluster ids</span></span>
<span>                   weights <span class="op">=</span> <span class="va">surv_weight_cluster</span>, <span class="co"># weight variable created above</span></span>
<span>                   strata <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># sampling was simple (no strata)</span></span>
<span>                  <span class="op">)</span></span>
<span></span>
<span><span class="co">## stratified cluster ----------------------------------------------------------</span></span>
<span><span class="va">survey_design</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">as_survey_design</span><span class="op">(</span>ids <span class="op">=</span> <span class="va">village_name</span>, <span class="co"># cluster ids</span></span>
<span>                   weights <span class="op">=</span> <span class="va">surv_weight_cluster_strata</span>, <span class="co"># weight variable created above</span></span>
<span>                   strata <span class="op">=</span> <span class="va">health_district</span> <span class="co"># sampling was stratified by district</span></span>
<span>                  <span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="descriptive-analysis-2" class="section level2" number="1.7">
<h2>
<span class="header-section-number">1.7</span> Análisis descriptivo<a class="anchor" aria-label="anchor" href="#descriptive-analysis-2"><i class="fas fa-link"></i></a>
</h2>
<p>El análisis descriptivo básico y la visualización se tratan extensamente en otros capítulos del manual, por lo que no nos detendremos en ellos aquí. Para más detalles, consulta los capítulos sobre <a href="#descriptive-tables">tablas descriptivas</a>, <a href="#simple-statistical-tests">pruebas estadísticas</a>, <a href="#tables-for-presentation">tablas para presentaciones</a>, <a href="#ggplot-basics">conceptos básicos de ggplot</a> e <a href="#reports-with-r-markdown">informes con R markdown</a>.</p>
<p>En este apartado nos centraremos en cómo investigar el sesgo de la muestra y visualizarlo. También veremos cómo visualizar el flujo de la población en un entorno de encuesta utilizando diagramas aluviales/sankey.</p>
<p>En general, debes considerar incluir los siguientes análisis descriptivos:</p>
<ul>
<li>Número final de agrupaciones, hogares e individuos incluidos</li>
<li>Número de personas excluidas y motivos de la exclusión</li>
<li>Mediana (rango) del número de hogares por grupo y de individuos por hogar</li>
</ul>
<div id="sesgo-de-muestreo" class="section level3 unnumbered">
<h3>Sesgo de muestreo<a class="anchor" aria-label="anchor" href="#sesgo-de-muestreo"><i class="fas fa-link"></i></a>
</h3>
<p>Compara las proporciones de cada grupo de edad entre tu muestra y la población de origen. Esto es importante para poder resaltar el posible sesgo de muestreo. También puedes repetir esta operación para ver las distribuciones por sexo.</p>
<p>Ten en cuenta que estos valores-p son sólo indicativos, y que una discusión descriptiva (o la visualización con las pirámides de edad que aparecen a continuación) de las distribuciones en tu muestra de estudio en comparación con la población de origen es más importante que la prueba binomial en sí. Esto se debe a que el aumento del tamaño de la muestra suele dar lugar a diferencias que pueden ser irrelevantes después de ponderar los datos.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## counts and props of the study population</span></span>
<span><span class="va">ag</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">tally</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>proportion <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, </span>
<span>         n_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## counts and props of the source population</span></span>
<span><span class="va">propcount</span> <span class="op">&lt;-</span> <span class="va">population</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">tally</span><span class="op">(</span><span class="va">population</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>proportion <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## bind together the columns of two tables, group by age, and perform a </span></span>
<span><span class="co">## binomial test to see if n/total is significantly different from population</span></span>
<span><span class="co">## proportion.</span></span>
<span>  <span class="co">## suffix here adds to text to the end of columns in each of the two datasets</span></span>
<span><span class="fu">left_join</span><span class="op">(</span><span class="va">ag</span>, <span class="va">propcount</span>, by <span class="op">=</span> <span class="st">"age_group"</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_pop"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">## broom::tidy(binom.test()) makes a data frame out of the binomial test and</span></span>
<span>  <span class="co">## will add the variables p.value, parameter, conf.low, conf.high, method, and</span></span>
<span>  <span class="co">## alternative. We will only use p.value here. You can include other</span></span>
<span>  <span class="co">## columns if you want to report confidence intervals</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>binom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html">binom.test</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">n_total</span>, <span class="va">proportion_pop</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">binom</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># important for expanding the binom.test data frame</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>proportion_pop <span class="op">=</span> <span class="va">proportion_pop</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">## Adjusting the p-values to correct for false positives </span></span>
<span>  <span class="co">## (because testing multiple age groups). This will only make </span></span>
<span>  <span class="co">## a difference if you have many age categories</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>p.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">p.value</span>, method <span class="op">=</span> <span class="st">"holm"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>                      </span>
<span>  <span class="co">## Only show p-values over 0.001 (those under report as &lt;0.001)</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>p.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">p.value</span> <span class="op">&lt;</span> <span class="fl">0.001</span>, </span>
<span>                          <span class="st">"&lt;0.001"</span>, </span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">p.value</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  </span>
<span>  <span class="co">## rename the columns appropriately</span></span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="st">"Age group"</span> <span class="op">=</span> <span class="va">age_group</span>,</span>
<span>    <span class="st">"Study population (n)"</span> <span class="op">=</span> <span class="va">n</span>,</span>
<span>    <span class="st">"Study population (%)"</span> <span class="op">=</span> <span class="va">proportion</span>,</span>
<span>    <span class="st">"Source population (n)"</span> <span class="op">=</span> <span class="va">n_pop</span>,</span>
<span>    <span class="st">"Source population (%)"</span> <span class="op">=</span> <span class="va">proportion_pop</span>,</span>
<span>    <span class="st">"P-value"</span> <span class="op">=</span> <span class="va">p.value</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 5 × 6
## # Groups:   Age group [5]
##   `Age group` `Study population (n)` `Study population (%)` Source populatio…¹ Sourc…² P-val…³
##   &lt;chr&gt;                        &lt;int&gt;                  &lt;dbl&gt;              &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  
## 1 0-2                             12                 0.0256               1360     6.8 &lt;0.001 
## 2 3-14                            42                 0.0896               7244    36.2 &lt;0.001 
## 3 15-29                           64                 0.136                5520    27.6 &lt;0.001 
## 4 30-44                           52                 0.111                3232    16.2 0.002  
## 5 45+                            299                 0.638                2644    13.2 &lt;0.001 
## # … with abbreviated variable names ¹​`Source population (n)`, ²​`Source population (%)`,
## #   ³​`P-value`</code></pre>
</div>
<div id="pirámides-demográficas" class="section level3 unnumbered">
<h3>Pirámides demográficas<a class="anchor" aria-label="anchor" href="#pir%C3%A1mides-demogr%C3%A1ficas"><i class="fas fa-link"></i></a>
</h3>
<p>Las pirámides demográficas (o de edad y sexo) son una forma sencilla de visualizar la distribución de la población de la encuesta. También vale la pena considerar la creación de <a href="#descriptive-tables">tablas descriptivas</a> de edad y sexo por estratos de la encuesta. Demostraremos el uso del paquete <strong>apyramid</strong>, ya que permite las proporciones ponderadas utilizando nuestro objeto de diseño de la encuesta creado anteriormente. Otras opciones para crear <a href="#demographic-pyramids-and-likert-scales">pirámides demográficas</a> se tratan ampliamente en ese capítulo del manual. También utilizaremos una función envolvente de <strong>sitrep</strong> llamada <code>age_pyramid()</code> que ahorra algunas líneas de codificación para producir un gráfico con proporciones.</p>
<p>Al igual que con el test binomial formal de la diferencia, vista anteriormente en la sección de sesgo de muestreo, aquí estamos interesados en visualizar si nuestra población muestreada es sustancialmente diferente de la población de origen y si la ponderación corrige esta diferencia. Para ello, utilizaremos el paquete <strong>patchwork</strong> para mostrar nuestras visualizaciones <strong>ggplot</strong> una al lado de la otra; para más detalles, consulta la sección sobre la combinación de gráficos en el capítulo de <a href="#combine-plots">consejos de ggplot</a> del manual. Visualizaremos nuestra población de origen, nuestra población de encuesta no ponderada y nuestra población de encuesta ponderada. También puedes considerar la posibilidad de visualizar por cada estrato de tu encuesta - en nuestro ejemplo aquí sería utilizando el argumento <code>stack_by = "health_district"</code> (ver <code>?plot_age_pyramid</code> para más detalles).</p>
<p><span style="color: black;"><strong><em>NOTA:</em></strong> Los ejes-x e y están invertidos en las pirámides</span></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define x-axis limits and labels ---------------------------------------------</span></span>
<span><span class="co">## (update these numbers to be the values for your graph)</span></span>
<span><span class="va">max_prop</span> <span class="op">&lt;-</span> <span class="fl">35</span>      <span class="co"># choose the highest proportion you want to show </span></span>
<span><span class="va">step</span> <span class="op">&lt;-</span> <span class="fl">5</span>           <span class="co"># choose the space you want beween labels </span></span>
<span></span>
<span><span class="co">## this part defines vector using the above numbers with axis breaks</span></span>
<span><span class="va">breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">max_prop</span><span class="op">/</span><span class="fl">100</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span> <span class="op">-</span> <span class="va">step</span><span class="op">/</span><span class="fl">100</span>, <span class="va">step</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>, </span>
<span>    <span class="fl">0</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">step</span> <span class="op">/</span> <span class="fl">100</span>, <span class="va">max_prop</span><span class="op">/</span><span class="fl">100</span>, <span class="va">step</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## this part defines vector using the above numbers with axis limits</span></span>
<span><span class="va">limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">max_prop</span><span class="op">/</span><span class="fl">100</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span>, <span class="va">max_prop</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## this part defines vector using the above numbers with axis labels</span></span>
<span><span class="va">labels</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">max_prop</span>, <span class="va">step</span>, <span class="op">-</span><span class="va">step</span><span class="op">)</span>, </span>
<span>      <span class="fl">0</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">step</span>, <span class="va">max_prop</span>, <span class="va">step</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## create plots individually  --------------------------------------------------</span></span>
<span></span>
<span><span class="co">## plot the source population </span></span>
<span><span class="co">## nb: this needs to be collapsed for the overall population (i.e. removing health districts)</span></span>
<span><span class="va">source_population</span> <span class="op">&lt;-</span> <span class="va">population</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co">## ensure that age and sex are factors</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">age_group</span>, </span>
<span>                            levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0-2"</span>, </span>
<span>                                       <span class="st">"3-14"</span>, </span>
<span>                                       <span class="st">"15-29"</span>,</span>
<span>                                       <span class="st">"30-44"</span>, </span>
<span>                                       <span class="st">"45+"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>         sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">age_group</span>, <span class="va">sex</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## add the counts for each health district together </span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span>population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## remove the grouping so can calculate overall proportion</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>proportion <span class="op">=</span> <span class="va">population</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## plot pyramid </span></span>
<span>  <span class="fu">age_pyramid</span><span class="op">(</span></span>
<span>            age_group <span class="op">=</span> <span class="va">age_group</span>, </span>
<span>            split_by <span class="op">=</span> <span class="va">sex</span>, </span>
<span>            count <span class="op">=</span> <span class="va">proportion</span>, </span>
<span>            proportional <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## only show the y axis label (otherwise repeated in all three plots)</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Source population"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">""</span>, </span>
<span>       x <span class="op">=</span> <span class="st">"Age group (years)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make the x axis the same for all plots </span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">breaks</span>, </span>
<span>    limits <span class="op">=</span> <span class="va">limits</span>, </span>
<span>    labels <span class="op">=</span> <span class="va">labels</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span><span class="co">## plot the unweighted sample population </span></span>
<span><span class="va">sample_population</span> <span class="op">&lt;-</span> <span class="fu">age_pyramid</span><span class="op">(</span><span class="va">survey_data</span>, </span>
<span>                 age_group <span class="op">=</span> <span class="st">"age_group"</span>, </span>
<span>                 split_by <span class="op">=</span> <span class="st">"sex"</span>,</span>
<span>                 proportion <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## only show the x axis label (otherwise repeated in all three plots)</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Unweighted sample population"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Proportion (%)"</span>, </span>
<span>       x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make the x axis the same for all plots </span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">breaks</span>, </span>
<span>    limits <span class="op">=</span> <span class="va">limits</span>, </span>
<span>    labels <span class="op">=</span> <span class="va">labels</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## plot the weighted sample population </span></span>
<span><span class="va">weighted_population</span> <span class="op">&lt;-</span> <span class="va">survey_design</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## make sure the variables are factors</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span>, </span>
<span>         sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">age_pyramid</span><span class="op">(</span> </span>
<span>    age_group <span class="op">=</span> <span class="st">"age_group"</span>,</span>
<span>    split_by <span class="op">=</span> <span class="st">"sex"</span>, </span>
<span>    proportion <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## only show the x axis label (otherwise repeated in all three plots)</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Weighted sample population"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">""</span>, </span>
<span>       x <span class="op">=</span> <span class="st">""</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="co">## make the x axis the same for all plots </span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">breaks</span>, </span>
<span>    limits <span class="op">=</span> <span class="va">limits</span>, </span>
<span>    labels <span class="op">=</span> <span class="va">labels</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## combine all three plots  ----------------------------------------------------</span></span>
<span><span class="co">## combine three plots next to eachother using + </span></span>
<span><span class="va">source_population</span> <span class="op">+</span> <span class="va">sample_population</span> <span class="op">+</span> <span class="va">weighted_population</span> <span class="op">+</span> </span>
<span>  <span class="co">## only show one legend and define theme </span></span>
<span>  <span class="co">## note the use of &amp; for combining theme with plot_layout()</span></span>
<span>  <span class="fu">plot_layout</span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,                    <span class="co"># move legend to bottom</span></span>
<span>        legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,                <span class="co"># remove title</span></span>
<span>        text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,                <span class="co"># change text size</span></span>
<span>        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span>, vjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># turn x-axis text</span></span>
<span>       <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/weighted_age_pyramid-1.png" width="1440"></div>
</div>
<div id="diagrama-aluvialsankey" class="section level3 unnumbered">
<h3>Diagrama aluvial/sankey<a class="anchor" aria-label="anchor" href="#diagrama-aluvialsankey"><i class="fas fa-link"></i></a>
</h3>
<p>Visualizar los puntos de partida y los resultados de los individuos puede ser muy útil para obtener una visión general. Su aplicación es bastante obvia en el caso de las poblaciones móviles, pero hay muchas otras aplicaciones, como las cohortes o cualquier otra situación en la que haya transiciones de estados para los individuos. Estos diagramas tienen varios nombres diferentes, como diagramas aluviales, de sankey y paralelos; los detalles se encuentran en el capítulo del manual sobre <a href="#alluvialsankey-diagrams">diagramas y gráficos</a>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## summarize data</span></span>
<span><span class="va">flow_table</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">startcause</span>, <span class="va">endcause</span>, <span class="va">sex</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># get counts </span></span>
<span>  <span class="fu">gather_set_data</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"startcause"</span>, <span class="st">"endcause"</span><span class="op">)</span><span class="op">)</span>     <span class="co"># change format for plotting</span></span>
<span></span>
<span></span>
<span><span class="co">## plot your dataset </span></span>
<span>  <span class="co">## on the x axis is the start and end causes</span></span>
<span>  <span class="co">## gather_set_data generates an ID for each possible combination</span></span>
<span>  <span class="co">## splitting by y gives the possible start/end combos</span></span>
<span>  <span class="co">## value as n gives it as counts (could also be changed to proportion)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">flow_table</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, id <span class="op">=</span> <span class="va">id</span>, split <span class="op">=</span> <span class="va">y</span>, value <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## colour lines by sex </span></span>
<span>  <span class="fu">geom_parallel_sets</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, axis.width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## fill in the label boxes grey</span></span>
<span>  <span class="fu">geom_parallel_sets_axes</span><span class="op">(</span>axis.width <span class="op">=</span> <span class="fl">0.15</span>, fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## change text colour and angle (needs to be adjusted)</span></span>
<span>  <span class="fu">geom_parallel_sets_labels</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, angle <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## remove axis labels</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="co">## move legend to bottom</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span>              </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/visualise_population_flow-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="weighted-proportions" class="section level2" number="1.8">
<h2>
<span class="header-section-number">1.8</span> Proporciones ponderadas<a class="anchor" aria-label="anchor" href="#weighted-proportions"><i class="fas fa-link"></i></a>
</h2>
<p>Esta sección detallará cómo producir tablas para recuentos y proporciones ponderadas, con los intervalos de confianza asociados y el efecto del diseño. Hay cuatro opciones diferentes que utilizan funciones de los siguientes paquetes: <strong>survey</strong>, <strong>srvyr</strong>, <strong>sitrep</strong> y <strong>gtsummary</strong>. Para una codificación mínima que produzca una tabla de estilo epidemiológico estándar, recomendaríamos la función sitrep - que es una envoltura para el código <strong>srvyr</strong>; Ten en cuenta, sin embargo, que esto no está todavía en CRAN y puede cambiar en el futuro. Por lo demás, es probable que el código de <strong>survey</strong> sea el más estable a largo plazo, mientras que <strong>srvyr</strong> se adaptará mejor a los flujos de trabajo de tidyverse. Aunque las funciones de <strong>gtsummary</strong> tienen mucho potencial, parecen ser experimentales e incompletas en el momento de escribir este artículo.</p>
<div id="paquete-survey-1" class="section level3 unnumbered">
<h3>Paquete <strong>survey</strong><a class="anchor" aria-label="anchor" href="#paquete-survey-1"><i class="fas fa-link"></i></a>
</h3>
<p>Podemos utilizar la función <code>svyciprop()</code> de <strong>survey</strong> para obtener las proporciones ponderadas y los correspondientes intervalos de confianza del 95%. Se puede extraer un efecto de diseño apropiado utilizando la función <code>svymean()</code> en lugar de <code>svyprop()</code>. Cabe señalar que <code>svyprop()</code> sólo parece aceptar variables entre 0 y 1 (o TRUE/FALSE), por lo que las variables categóricas no funcionarán.</p>
<p><span style="color: black;"><strong><em>NOTA:</em></strong> Las funciones de <strong>survey</strong> también aceptan objetos de diseño <strong>srvyr</strong>, pero aquí hemos utilizado el objeto de diseño de <strong>survey</strong> sólo por coherencia</span></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## produce weighted counts </span></span>
<span><span class="fu">svytable</span><span class="op">(</span><span class="op">~</span><span class="va">died</span>, <span class="va">base_survey_design</span><span class="op">)</span></span></code></pre></div>
<pre><code>## died
##      FALSE       TRUE 
## 1406244.43   76213.01</code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## produce weighted proportions</span></span>
<span><span class="fu">svyciprop</span><span class="op">(</span><span class="op">~</span><span class="va">died</span>, <span class="va">base_survey_design</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<pre><code>##               2.5% 97.5%
## died 0.0514 0.0208  0.12</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get the design effect </span></span>
<span><span class="fu">svymean</span><span class="op">(</span><span class="op">~</span><span class="va">died</span>, <span class="va">base_survey_design</span>, na.rm <span class="op">=</span> <span class="cn">T</span>, deff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">deff</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## diedFALSE  diedTRUE 
##  3.755508  3.755508</code></pre>
<p>Podemos combinar las funciones de <strong>survey</strong> mostradas arriba en una función que definimos nosotros mismos a continuación, llamada <code>svy_prop</code>; y podemos entonces usar esa función junto con <code>map()</code> del paquete purrr para iterar sobre varias variables y crear una tabla. Consulta el capítulo de <a href="#iteration-loops-and-lists">iteración</a> del manual para obtener más detalles sobre <strong>purrr</strong>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define function to calculate weighted counts, proportions, CI and design effect</span></span>
<span><span class="co"># x is the variable in quotation marks </span></span>
<span><span class="co"># design is your survey design object</span></span>
<span></span>
<span><span class="va">svy_prop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">design</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## put the variable of interest in a formula </span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span> <span class="st">"~"</span> , <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## only keep the TRUE column of counts from svytable</span></span>
<span>  <span class="va">weighted_counts</span> <span class="op">&lt;-</span> <span class="fu">svytable</span><span class="op">(</span><span class="va">form</span>, <span class="va">design</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co">## calculate proportions (multiply by 100 to get percentages)</span></span>
<span>  <span class="va">weighted_props</span> <span class="op">&lt;-</span> <span class="fu">svyciprop</span><span class="op">(</span><span class="va">form</span>, <span class="va">design</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="co">## extract the confidence intervals and multiply to get percentages</span></span>
<span>  <span class="va">weighted_confint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">weighted_props</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="co">## use svymean to calculate design effect and only keep the TRUE column</span></span>
<span>  <span class="va">design_eff</span> <span class="op">&lt;-</span> <span class="fu">deff</span><span class="op">(</span><span class="fu">svymean</span><span class="op">(</span><span class="va">form</span>, <span class="va">design</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, deff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="cn">TRUE</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co">## combine in to one data frame</span></span>
<span>  <span class="va">full_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span></span>
<span>    <span class="st">"Variable"</span>        <span class="op">=</span> <span class="va">x</span>,</span>
<span>    <span class="st">"Count"</span>           <span class="op">=</span> <span class="va">weighted_counts</span>,</span>
<span>    <span class="st">"Proportion"</span>      <span class="op">=</span> <span class="va">weighted_props</span>,</span>
<span>    <span class="va">weighted_confint</span>, </span>
<span>    <span class="st">"Design effect"</span>   <span class="op">=</span> <span class="va">design_eff</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## return table as a dataframe</span></span>
<span>  <span class="va">full_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">full_table</span>, </span>
<span>             <span class="co">## remove the variable names from rows (is a separate column now)</span></span>
<span>             row.names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## change numerics back to numeric</span></span>
<span>  <span class="va">full_table</span><span class="op">[</span> , <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">full_table</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## return dataframe</span></span>
<span>  <span class="va">full_table</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## iterate over several variables to create a table </span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  <span class="co">## define variables of interest</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"died"</span>, <span class="st">"arrived"</span><span class="op">)</span>, </span>
<span>  <span class="co">## state function using and arguments for that function (design)</span></span>
<span>  <span class="va">svy_prop</span>, design <span class="op">=</span> <span class="va">base_survey_design</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## collapse list in to a single data frame</span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## round </span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">where</span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">round</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##   Variable    Count Proportion X2.5. X97.5. Design.effect
## 1     left 701199.1       47.3  39.2   55.5           2.4
## 2     died  76213.0        5.1   2.1   12.1           3.8
## 3  arrived 761799.0       51.4  40.9   61.7           3.9</code></pre>
</div>
<div id="paquete-srvyr-1" class="section level3 unnumbered">
<h3>Paquete <strong>Srvyr</strong><a class="anchor" aria-label="anchor" href="#paquete-srvyr-1"><i class="fas fa-link"></i></a>
</h3>
<p>Con <strong>srvyr</strong> podemos utilizar la sintaxis de <strong>dplyr</strong> para crear una tabla. Observa que se utiliza la función <code>survey_mean()</code> y se especifica el argumento de la proporción, y también que se utiliza la misma función para calcular el efecto del diseño. Esto se debe a que <strong>srvyr</strong> envuelve las dos funciones del paquete <strong>survey</strong>, <code>svyciprop()</code> y <code>svymean()</code>, que se utilizan en la sección anterior.</p>
<p><span style="color: black;"><strong><em>NOTA:</em></strong> Tampoco parece posible obtener proporciones a partir de variables categóricas utilizando <strong>srvyr</strong>, si lo necesitas, consulta la sección siguiente utilizando <strong>sitrep </strong></span></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## use the srvyr design object</span></span>
<span><span class="va">survey_design</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    <span class="co">## produce the weighted counts </span></span>
<span>    counts <span class="op">=</span> <span class="fu">survey_total</span><span class="op">(</span><span class="va">died</span><span class="op">)</span>, </span>
<span>    <span class="co">## produce weighted proportions and confidence intervals </span></span>
<span>    <span class="co">## multiply by 100 to get a percentage </span></span>
<span>    props <span class="op">=</span> <span class="fu">survey_mean</span><span class="op">(</span><span class="va">died</span>, </span>
<span>                        proportion <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                        vartype <span class="op">=</span> <span class="st">"ci"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, </span>
<span>    <span class="co">## produce the design effect </span></span>
<span>    deff <span class="op">=</span> <span class="fu">survey_mean</span><span class="op">(</span><span class="va">died</span>, deff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## only keep the rows of interest</span></span>
<span>  <span class="co">## (drop standard errors and repeat proportion calculation)</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">counts</span>, <span class="va">props</span>, <span class="va">props_low</span>, <span class="va">props_upp</span>, <span class="va">deff_deff</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 1 × 5
##   counts props props_low props_upp deff_deff
##    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 76213.  5.14      2.08      12.1      3.76</code></pre>
<p>Aquí también podríamos escribir una función para iterar sobre múltiples variables utilizando el paquete purrr. Consulta el capítulo de <a href="#iteration-loops-and-lists">iteración</a> del manual para obtener más detalles sobre <strong>purrr</strong>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define function to calculate weighted counts, proportions, CI and design effect</span></span>
<span><span class="co"># design is your survey design object</span></span>
<span><span class="co"># x is the variable in quotation marks </span></span>
<span></span>
<span></span>
<span><span class="va">srvyr_prop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">design</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    <span class="co">## using the survey design object</span></span>
<span>    <span class="va">design</span>, </span>
<span>    <span class="co">## produce the weighted counts </span></span>
<span>    counts <span class="op">=</span> <span class="fu">survey_total</span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, </span>
<span>    <span class="co">## produce weighted proportions and confidence intervals </span></span>
<span>    <span class="co">## multiply by 100 to get a percentage </span></span>
<span>    props <span class="op">=</span> <span class="fu">survey_mean</span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                        proportion <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                        vartype <span class="op">=</span> <span class="st">"ci"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, </span>
<span>    <span class="co">## produce the design effect </span></span>
<span>    deff <span class="op">=</span> <span class="fu">survey_mean</span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>, deff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## add in the variable name</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">x</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## only keep the rows of interest</span></span>
<span>  <span class="co">## (drop standard errors and repeat proportion calculation)</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">variable</span>, <span class="va">counts</span>, <span class="va">props</span>, <span class="va">props_low</span>, <span class="va">props_upp</span>, <span class="va">deff_deff</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span>  </span>
<span></span>
<span><span class="co">## iterate over several variables to create a table </span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  <span class="co">## define variables of interest</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"died"</span>, <span class="st">"arrived"</span><span class="op">)</span>, </span>
<span>  <span class="co">## state function using and arguments for that function (design)</span></span>
<span>  <span class="op">~</span><span class="fu">srvyr_prop</span><span class="op">(</span><span class="va">.x</span>, design <span class="op">=</span> <span class="va">survey_design</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## collapse list in to a single data frame</span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 3 × 6
##   variable  counts props props_low props_upp deff_deff
##   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 left     701199. 47.3      39.2       55.5      2.38
## 2 died      76213.  5.14      2.08      12.1      3.76
## 3 arrived  761799. 51.4      40.9       61.7      3.93</code></pre>
</div>
<div id="paquete-sitrep" class="section level3 unnumbered">
<h3>Paquete <strong>Sitrep</strong><a class="anchor" aria-label="anchor" href="#paquete-sitrep"><i class="fas fa-link"></i></a>
</h3>
<p>La función <code>tab_survey()</code> de <strong>sitrep</strong> es una envoltura para <strong>srvyr</strong>, que permite crear tablas ponderadas con una codificación mínima. También permite calcular proporciones ponderadas para variables categóricas.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## using the survey design object</span></span>
<span><span class="va">survey_design</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## pass the names of variables of interest unquoted</span></span>
<span>  <span class="fu">tab_survey</span><span class="op">(</span><span class="va">arrived</span>, <span class="va">left</span>, <span class="va">died</span>, <span class="va">education_level</span>,</span>
<span>             deff <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co"># calculate the design effect</span></span>
<span>             pretty <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># merge the proportion and 95%CI</span></span>
<span>             <span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: removing 257 missing value(s) from `education_level`</code></pre>
<pre><code>## # A tibble: 9 × 5
##   variable        value            n  deff ci                
##   &lt;chr&gt;           &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;             
## 1 arrived         TRUE       761799.  3.93 51.4% (40.9--61.7)
## 2 arrived         FALSE      720658.  3.93 48.6% (38.3--59.1)
## 3 left            TRUE       701199.  2.38 47.3% (39.2--55.5)
## 4 left            FALSE      781258.  2.38 52.7% (44.5--60.8)
## 5 died            TRUE        76213.  3.76 5.1% (2.1--12.1)  
## 6 died            FALSE     1406244.  3.76 94.9% (87.9--97.9)
## 7 education_level higher     171644.  4.70 42.4% (26.9--59.7)
## 8 education_level primary    102609.  2.37 25.4% (16.2--37.3)
## 9 education_level secondary  130201.  6.68 32.2% (16.5--53.3)</code></pre>
</div>
<div id="paquete-gtsummary" class="section level3 unnumbered">
<h3>Paquete <strong>Gtsummary</strong><a class="anchor" aria-label="anchor" href="#paquete-gtsummary"><i class="fas fa-link"></i></a>
</h3>
<p>Con <strong>gtsummary</strong> no parece haber todavía funciones incorporadas para añadir intervalos de confianza o efecto de diseño. Aquí mostramos cómo definir una función para añadir intervalos de confianza y luego añadir intervalos de confianza a una tabla gtsummary creada con la función <code>tbl_svysummary()</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">confidence_intervals</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">variable</span>, <span class="va">by</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## extract the confidence intervals and multiply to get percentages</span></span>
<span>  <span class="va">props</span> <span class="op">&lt;-</span> <span class="fu">svyciprop</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span> <span class="st">"~"</span> , <span class="va">variable</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="va">data</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## extract the confidence intervals </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## make numeric and multiply for percentage</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>           <span class="co">## round to one digit</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>                           <span class="co">## extract the numbers from matrix</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">.</span>, collapse <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>          <span class="co">## combine to single character</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## using the survey package design object</span></span>
<span><span class="fu">tbl_svysummary</span><span class="op">(</span><span class="va">base_survey_design</span>, </span>
<span>               include <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">arrived</span>, <span class="va">left</span>, <span class="va">died</span><span class="op">)</span>,   <span class="co">## define variables want to include</span></span>
<span>               statistic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"{n} ({p}%)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## define stats of interest</span></span>
<span>  <span class="fu">add_n</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">## add the weighted total </span></span>
<span>  <span class="fu">add_stat</span><span class="op">(</span>fns <span class="op">=</span> <span class="fu">everything</span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="va">confidence_intervals</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## add CIs</span></span>
<span>  <span class="co">## modify the column headers</span></span>
<span>  <span class="fu">modify_header</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="va">n</span> <span class="op">~</span> <span class="st">"**Weighted total (N)**"</span>,</span>
<span>      <span class="va">stat_0</span> <span class="op">~</span> <span class="st">"**Weighted Count**"</span>,</span>
<span>      <span class="va">add_stat_1</span> <span class="op">~</span> <span class="st">"**95%CI**"</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<div id="jmmqkatfmv" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#jmmqkatfmv .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#jmmqkatfmv .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jmmqkatfmv .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#jmmqkatfmv .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#jmmqkatfmv .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jmmqkatfmv .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jmmqkatfmv .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#jmmqkatfmv .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#jmmqkatfmv .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#jmmqkatfmv .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#jmmqkatfmv .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#jmmqkatfmv .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#jmmqkatfmv .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#jmmqkatfmv .gt_from_md > :first-child {
  margin-top: 0;
}

#jmmqkatfmv .gt_from_md > :last-child {
  margin-bottom: 0;
}

#jmmqkatfmv .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#jmmqkatfmv .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#jmmqkatfmv .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#jmmqkatfmv .gt_row_group_first td {
  border-top-width: 2px;
}

#jmmqkatfmv .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jmmqkatfmv .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#jmmqkatfmv .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#jmmqkatfmv .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jmmqkatfmv .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jmmqkatfmv .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#jmmqkatfmv .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#jmmqkatfmv .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jmmqkatfmv .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jmmqkatfmv .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jmmqkatfmv .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jmmqkatfmv .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#jmmqkatfmv .gt_left {
  text-align: left;
}

#jmmqkatfmv .gt_center {
  text-align: center;
}

#jmmqkatfmv .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#jmmqkatfmv .gt_font_normal {
  font-weight: normal;
}

#jmmqkatfmv .gt_font_bold {
  font-weight: bold;
}

#jmmqkatfmv .gt_font_italic {
  font-style: italic;
}

#jmmqkatfmv .gt_super {
  font-size: 65%;
}

#jmmqkatfmv .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#jmmqkatfmv .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#jmmqkatfmv .gt_indent_1 {
  text-indent: 5px;
}

#jmmqkatfmv .gt_indent_2 {
  text-indent: 10px;
}

#jmmqkatfmv .gt_indent_3 {
  text-indent: 15px;
}

#jmmqkatfmv .gt_indent_4 {
  text-indent: 20px;
}

#jmmqkatfmv .gt_indent_5 {
  text-indent: 25px;
}
</style>
<div class="inline-table"><table class="gt_table">
<thead class="gt_col_headings"><tr>
<th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col"><strong>Characteristic</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col"><strong>Weighted total (N)</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col">
<strong>Weighted Count</strong><sup class="gt_footnote_marks">1</sup>
</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col"><strong>95%CI</strong></th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td class="gt_row gt_left">arrived</td>
<td class="gt_row gt_center">1,482,457</td>
<td class="gt_row gt_center">761,799 (51%)</td>
<td class="gt_row gt_center">40.9-61.7</td>
</tr>
<tr>
<td class="gt_row gt_left">left</td>
<td class="gt_row gt_center">1,482,457</td>
<td class="gt_row gt_center">701,199 (47%)</td>
<td class="gt_row gt_center">39.2-55.5</td>
</tr>
<tr>
<td class="gt_row gt_left">died</td>
<td class="gt_row gt_center">1,482,457</td>
<td class="gt_row gt_center">76,213 (5.1%)</td>
<td class="gt_row gt_center">2.1-12.1</td>
</tr>
</tbody>
<tfoot class="gt_footnotes"><tr>
<td class="gt_footnote" colspan="4">
<sup class="gt_footnote_marks">1</sup> n (%)</td>
    </tr></tfoot>
</table></div>
</div>
<!-- ======================================================= -->
</div>
</div>
<div id="weighted-ratios" class="section level2" number="1.9">
<h2>
<span class="header-section-number">1.9</span> Razones ponderadas<a class="anchor" aria-label="anchor" href="#weighted-ratios"><i class="fas fa-link"></i></a>
</h2>
<p>Del mismo modo, para los ratios ponderados (como los ratios de mortalidad) puedes utilizar el paquete <strong>survey</strong> o <strong>srvyr</strong>. También se pueden escribir funciones (similares a las anteriores) para iterar sobre varias variables. También se podría crear una función para <strong>gtsummary</strong> como la anterior, pero actualmente no tiene una funcionalidad incorporada.</p>
<div id="paquete-survey-2" class="section level3 unnumbered">
<h3>Paquete <strong>survey</strong><a class="anchor" aria-label="anchor" href="#paquete-survey-2"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ratio</span> <span class="op">&lt;-</span> <span class="fu">svyratio</span><span class="op">(</span><span class="op">~</span><span class="va">died</span>, </span>
<span>         denominator <span class="op">=</span> <span class="op">~</span><span class="va">obstime</span>, </span>
<span>         design <span class="op">=</span> <span class="va">base_survey_design</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">ratio</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">ratio</span><span class="op">$</span><span class="va">ratio</span> <span class="op">*</span> <span class="fl">10000</span>, </span>
<span>  <span class="va">ci</span> <span class="op">*</span> <span class="fl">10000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>##       obstime    2.5 %   97.5 %
## died 5.981922 1.194294 10.76955</code></pre>
</div>
<div id="paquete-srvyr-2" class="section level3 unnumbered">
<h3>Paquete <strong>Srvyr</strong><a class="anchor" aria-label="anchor" href="#paquete-srvyr-2"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">survey_design</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co">## survey ratio used to account for observation time </span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    mortality <span class="op">=</span> <span class="fu">survey_ratio</span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">died</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10000</span>, </span>
<span>      <span class="va">obstime</span>, </span>
<span>      vartype <span class="op">=</span> <span class="st">"ci"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 1 × 3
##   mortality mortality_low mortality_upp
##       &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
## 1      5.98         0.349          11.6</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="resources-18" class="section level2" number="1.10">
<h2>
<span class="header-section-number">1.10</span> Recursos<a class="anchor" aria-label="anchor" href="#resources-18"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://stats.idre.ucla.edu/r/seminars/survey-data-analysis-with-r/">Página de estadísticas de la UCLA</a></p>
<p><a href="http://asdfree.com/">Analizar datos de encuestas gratis</a></p>
<p><a href="http://gdfe.co/srvyr/">srvyr packge</a></p>
<p><a href="http://www.danieldsjoberg.com/gtsummary/reference/index.html">paquete gtsummary</a></p>
<p><a href="https://github.com/EPIET/RapidAssessmentSurveys">Estudios de caso de la encuesta EPIET</a></p>

<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="index.html"></a></div>
<div class="next"><a href="survival-analysis.html"><span class="header-section-number">2</span> Análisis de supervivencia</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#survey-analysis"><span class="header-section-number">1</span> Análisis de encuestas</a></li>
<li><a class="nav-link" href="#overview-4"><span class="header-section-number">1.1</span> Resumen</a></li>
<li>
<a class="nav-link" href="#preparation-17"><span class="header-section-number">1.2</span> Preparación</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#paquetes">Paquetes</a></li>
<li><a class="nav-link" href="#carga-de-datos">Carga de datos</a></li>
<li><a class="nav-link" href="#limpieza-de-datos">Limpieza de datos</a></li>
</ul>
</li>
<li><a class="nav-link" href="#survey-data"><span class="header-section-number">1.3</span> Datos de encuestas</a></li>
<li><a class="nav-link" href="#observation-time"><span class="header-section-number">1.4</span> Tiempo de observación</a></li>
<li><a class="nav-link" href="#weighting"><span class="header-section-number">1.5</span> Ponderación</a></li>
<li>
<a class="nav-link" href="#survey-design-objects"><span class="header-section-number">1.6</span> Objetos de diseño de la encuesta</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#paquete-survey">Paquete survey</a></li>
<li><a class="nav-link" href="#paquete-srvyr">Paquete Srvyr</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#descriptive-analysis-2"><span class="header-section-number">1.7</span> Análisis descriptivo</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sesgo-de-muestreo">Sesgo de muestreo</a></li>
<li><a class="nav-link" href="#pir%C3%A1mides-demogr%C3%A1ficas">Pirámides demográficas</a></li>
<li><a class="nav-link" href="#diagrama-aluvialsankey">Diagrama aluvial/sankey</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#weighted-proportions"><span class="header-section-number">1.8</span> Proporciones ponderadas</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#paquete-survey-1">Paquete survey</a></li>
<li><a class="nav-link" href="#paquete-srvyr-1">Paquete Srvyr</a></li>
<li><a class="nav-link" href="#paquete-sitrep">Paquete Sitrep</a></li>
<li><a class="nav-link" href="#paquete-gtsummary">Paquete Gtsummary</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#weighted-ratios"><span class="header-section-number">1.9</span> Razones ponderadas</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#paquete-survey-2">Paquete survey</a></li>
<li><a class="nav-link" href="#paquete-srvyr-2">Paquete Srvyr</a></li>
</ul>
</li>
<li><a class="nav-link" href="#resources-18"><span class="header-section-number">1.10</span> Recursos</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>EpiRhandbook en español</strong>" was written by El equipo del manual. It was last built on 2022-11-22.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
