
# Borrador. Organización de informes rutinarios {#organizing-routine-reports}

<span style="color: red;">**_ADVERTENCIA:_** Esta traducción es sólo un borrador de la traducción al español. Este documento tal cual está ha sido generado automáticamente con DeepL.com y se han hecho algunas correcciones globales. Está pendiente de una revisión completa. </span> 

Esta página cubre el paquete **reportfactory**, que es un *complemento para el uso de R Markdown para los informes*.

En situaciones en las que se ejecutan reportes de forma rutinaria (diariamente, semanalmente, etc.), facilita la compilación de múltiples archivos R Markdown y la organización de sus resultados. En esencia, proporciona una "fábrica" desde la que se pueden ejecutar los informes R Markdown, obtener automáticamente carpetas con fecha y hora para los resultados, y tener un control de versiones "ligero".

**reportfactory** es uno de los paquetes desarrollados por RECON (R Epidemics Consortium). Aquí está su [sitio web](https://www.repidemicsconsortium.org/) y [Github](https://github.com/reconverse). 


## Preparación {#preparation-31}

### Cargar paquetes {#load-packages-25}  

Desde RStudio, instala la última versión del paquete **reportfactory** desde Github.

Puedes hacerlo a través del paquete **pacman** con p_load_current_gh() que forzará la instalación de la última versión desde Github. Proporcione la cadena de caracteres "reconverse/reportfactory", que especifica la organización de Github (reconverse) y el repositorio (reportfactory). También puede utilizar `install_github()` del paquete **remotes**, como alternativa.

```{r, eval=FALSE}
# Install and load the latest version of the package from Github
pacman::p_load_current_gh("reconverse/reportfactory")
#remotes::install_github("reconverse/reportfactory") # alternative
```


## New factory  {#new-factory}

Para crear una nueva fábrica, ejecuta la función `new_factory()`. Esto creará una nueva carpeta de proyecto R autocontenida. Por defecto:

* La fábrica se añadirá a tu directorio de trabajo
* El nombre del proyecto R de la fábrica se llamará "nueva_fábrica.Rproj"
* Tu sesión de RStudio se "trasladará" a este proyecto R

```{r, eval=F}
# This will create the factory in the working directory
new_factory()
```

Mirando dentro de la fábrica, se puede ver que las subcarpetas y algunos archivos se crearon automáticamente.


```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new2.png"))
```

* La carpeta *report_sources* contendrá sus scripts R Markdown, que generan sus informes
* La carpeta de *resultas* contendrá los resultados del informe (por ejemplo, HTML, Word, PDF, etc.)
* La carpeta de *scripts* puede utilizarse para almacenar otros scripts de R (por ejemplo, los que se originan en sus scripts de Rmd)
* La carpeta de *data* puede utilizarse para guardar sus datos (se incluyen las subcarpetas "raw" y "clean")
* Un archivo *.here*, para que puedas utilizar el paquete **here** para llamar a los archivos de las subcarpetas por su relación con esta carpeta raíz (véase la página de [proyectos de R](#r-projects) para más detalles)
* Se ha creado un archivo *gitignore* en caso de que se vincule este proyecto R a un repositorio de Github (ver [Control de versiones y colaboración con Github])
* Un archivo README vacío, para si usas un repositorio de Github


<span style="color: orange;">**_ATENCIÓN::_** dependiendo de la configuración de tu ordenador, los archivos como ".here" pueden existir pero estar ocultos.</span>  

De los ajustes por defecto, a continuación hay varios que puede querer ajustar dentro del comando `new_factory()`: 

* `factory = ` - Proporcionar un nombre para la carpeta de fábrica (por defecto es "new_factory")
* `path = ` - Designa una ruta de archivo para la nueva fábrica (por defecto es el directorio de trabajo)
* `report_sources = ` Proporcione un nombre alternativo para la subcarpeta que contiene los scripts R Markdown (por defecto es "report_sources")
* `outputs = ` Proporcione un nombre alternativo para la carpeta que contiene los resultados del informe (por defecto es "outputs")

Véase ?new_factory para una lista completa de los argumentos.

Cuando se crea la nueva fábrica, tu sesión de R se transfiere al nuevo proyecto R, por lo que debes cargar de nuevo el paquete **reportfactory**.

```{r, eval=FALSE}
pacman::p_load(reportfactory)
```

Ahora puede ejecutar el comando `factory_overview()` para ver la estructura interna (todas las carpetas y archivos) de la fábrica. 

```{r, eval=F}
factory_overview()            # print overview of the factory to console
```

El siguiente "árbol" de las carpetas y archivos de la fábrica se imprime en la consola de R. Observe que en la carpeta "data" hay subcarpetas para los datos "raw" y "clean", y datos CSV de ejemplo. También hay "example_report.Rmd" en la carpeta "report_sources". 

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview.png"))
```


## Crear un informe {#create-a-report}

Desde la fábrica del proyecto R, crea un informe R Markdown como lo haría normalmente, y guárdalo en la carpeta "report_sources". Consulta la página de [R Markdown](reports-with-r-markdown) para obtener instrucciones. A modo de ejemplo, hemos añadido lo siguiente a la fábrica:

* Un nuevo script de R markdown titulado "daily_sitrep.Rmd", guardado dentro de la carpeta "report_sources".
* Datos para el informe ("linelist_cleaned.rds"), guardados en la subcarpeta "clean" dentro de la carpeta "data"

Podemos ver usando factory_overview() nuestro R Markdown en la carpeta "report_sources" y el archivo de datos en la carpeta de datos "clean" (resaltado):

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview2.png"))
```

A continuación se muestra una captura de pantalla del comienzo del R Markdown "daily_sitrep.Rmd". Puedes ver que el formato de salida está configurado para ser HTML, a través de la cabecera YAML `output: html_document`.

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_new_rmd.png"))
```

En este sencillo script, hay comandos para:

* Cargar los paquetes necesarios
* Importe los datos del listado utilizando una ruta de archivo del paquete **aquí** (lea más en la página sobre [importación y exportación](#import-and-export)) 

```{r, eval=F}
linelist <- import(here("data", "clean", "linelist_cleaned.rds"))
```

* Imprime una tabla resumen de los casos, y la exporta con `export()` como un archivo .csv
* Imprimir una epicurva, y exportarla con `ggsave()` como un archivo .png

Puedes revisar sólo la lista de informes R Markdown en la carpeta "report_sources" con este comando:

```{r, eval=F}
list_reports()
```



## Compilar   {#compile}

En una fábrica de informes, "compilar" un informe R Markdown significa que se ejecutará el script .Rmd y se producirá la salida (como se especifica en el script YAML, por ejemplo, como HTML, Word, PDF, etc.).

*La fábrica creará automáticamente una carpeta con fecha y hora para las salidas en la carpeta "outputs".*

El propio informe y cualquier archivo exportado producido por el script (por ejemplo, csv, png, xlsx) se guardarán en esta carpeta. Además, el propio script Rmd se guardará en esta carpeta, para que tenga un registro de esa versión del script.

Esto contrasta con el comportamiento normal de un R Markdown "tejido", que guarda las salidas en la ubicación del script Rmd. Este comportamiento por defecto puede resultar en carpetas abarrotadas y desordenadas. El objetivo de la fábrica es mejorar la organización cuando uno necesita ejecutar informes con frecuencia.

### Compilar por nombre {#compile-by-name}  

Puedes compilar un informe específico ejecutando `compile_reports()` y proporcionando el nombre del script Rmd (sin la extensión .Rmd) a `reports = `. Para simplificar, puede omitir `reports = ` y simplemente escribir el nombre R Markdown entre comillas, como se indica a continuación.  

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile1.png"))
```


Este comando compilaría sólo el informe "daily_sitrep.Rmd", guardando el informe HTML, y las exportaciones de la tabla .csv y la epicurva .png en una subcarpeta con fecha y hora específicas del informe, dentro de la carpeta "outputs".

Ten en cuenta que si elige proporcionar la extensión .Rmd, debe escribir correctamente la extensión tal y como se guarda en el nombre del archivo (.rmd vs. .Rmd).

Ten en cuenta también que, al compilar, es posible que aparezcan temporalmente varios archivos en la carpeta "report_sources", pero pronto desaparecerán al ser transferidos a la carpeta "outputs" correcta.

### Compilación por número {#compile-by-number}

También puede especificar el script Rmd a compilar proporcionando un número o vector de números a `reports = `. Los números deben alinearse con el orden en que aparecen los informes cuando se ejecuta `list_reports()`.


```{r, eval=F}
# Compile the second and fourth Rmds in the "report_sources" folder
compile_reports(reports = c(2, 4))
```



### Compilar todos {#compile-all}

Puedes compilar *todos* los informes R Markdown en la carpeta "report_sources" estableciendo el argumento `reports = `a TRUE.

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile_all.png"))
```


### Compilar desde la subcarpeta {#compile-from-sub-folder}  

Puedes añadir subcarpetas a la carpeta "report_sources". Para ejecutar un informe R Markdown desde una subcarpeta, simplemente proporcione el nombre de la carpeta a `subfolder = `. A continuación se muestra un ejemplo de código para compilar un informe Rmd que vive en una subcarpeta de "report_sources".

```{r, eval=F}
compile_reports(
     reports = "summary_for_partners.Rmd",
     subfolder = "for_partners")
```

Puedes compilar todos los informes Rmd dentro de una subcarpeta proporcionando el nombre de la subcarpeta a `reports = `, con una barra al final, como se indica a continuación.

```{r, eval=F}
compile_reports(reports = "for_partners/")
```


### Parametrización {#parameterization}

Como se indicó en la página sobre [Informes con R Markdown](#reports-with-r-markdown), puede ejecutar informes con parámetros especificados. Puedes pasar estos parámetros como una lista a `compile_reports()` a través del argumento `params = `. Por ejemplo, en este informe ficticio hay tres parámetros proporcionados a los informes de R Markdown.

```{r, eval=F}
compile_reports(
  reports = "daily_sitrep.Rmd",
  params = list(most_recent_data = TRUE,
                region = "NORTHERN",
                rates_denominator = 10000),
  subfolder = "regional"
)
```


### Utilizar un "run-file" {#using-a-run-file}  

Si tienes varios informes que ejecutar, considera la posibilidad de crear un script de R que contenga todos los comandos `compile_reports()`. Un usuario puede simplemente ejecutar todos los comandos en este script de R y todos los informes se compilarán. Puedes guardar este "archivo de ejecución" en la carpeta "scripts".


## Salidas {#outputs-1}   

Después de haber compilado los informes unas cuantas veces, la carpeta "outputs" podría tener este aspecto (los resaltados se han añadido para mayor claridad): 


```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_overview_all.png"))
```


* Dentro de "outputs", se han creado subcarpetas para cada informe Rmd
* Dentro de ellas, se han creado otras subcarpetas para cada compilación única
  * Están marcados con fecha y hora ("2021-04-23_T11-07-36" significa 23 de abril de 2021 a las 11:07:36)
  * Puedes editar el formato de la fecha/hora. Ver `?compile_reports`
* Dentro de cada carpeta compilada de fecha/hora, se almacena el resultado del informe (por ejemplo, HTML, PDF, Word) junto con el script Rmd (¡control de versiones!) y cualquier otro archivo exportado (por ejemplo, table.csv, epidemic_curve.png)

Esta es una vista dentro de una de las carpetas con fecha/hora, para el informe "daily_sitrep". La ruta del archivo está resaltada en amarillo para enfatizar.


```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_compile_folder.png"))
```


Por último, a continuación se muestra una captura de pantalla de la salida del informe HTML.


```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "factory_html.png"))
```

Puedes utilizar `list_outputs()` para revisar una lista de las salidas.




## Miscelánea  {#miscellaneous-1} 

### Knit {#knit} 

Si lo deseas, puedes "procesar" uno de tus informes R Markdown clicando el botón "Knit". Si haces esto, como por defecto, las salidas aparecerán en la carpeta donde se guarda el Rmd - la carpeta "report_sources". En versiones anteriores de **reportfactory**, tener cualquier archivo que no sea Rmd en "report_sources" impediría la compilación, pero esto ya no es así. Puedes ejecutar `compile_reports()` y no se producirá ningún error. 

### Scripts {#scripts-2}  

Te animamos a utilizar la carpeta "scripts" para almacenar "archivos de ejecución" o scripts .R que se originan en tus scripts .Rmd. Consulta la página sobre [R Markdown](#reports-with-r-markdown) para obtener consejos sobre cómo estructurar tu código en varios archivos. 


### Extras {#extras} 

* Con **reportfactory**, puede utilizar la función `list_deps()` para listar todos los paquetes requeridos en todos los informes de toda la fábrica.

* Hay un paquete de acompañamiento en desarrollo llamado **rfextras** que ofrece más funciones de ayuda para asistirle en la construcción de informes, tales como:
  * `load_scripts()` - carga todos los scripts .R en una carpeta determinada (la carpeta "scripts" por defecto)
  * `find_latest() `- encuentra la última versión de un archivo (por ejemplo, el último conjunto de datos)




<!-- ======================================================= -->
## Recursos {#resources-30}

Consulta la [página de Github del paquete **reportfactory**](https://github.com/reconverse/reportfactory)

Consulta la [página de Github del paquete **rfextras**](https://github.com/reconhub/rfextras) 

